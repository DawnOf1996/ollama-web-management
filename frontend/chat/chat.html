<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 聊天对话</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites/dist/css/foundation.min.css">
    <script src="../ajax.js" defer></script>
    <style>
        #chatContainer {
            height: 80vh; /* 中间区域占 80% 高度 */
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
            padding: 10px;
        }

        .user-message {
            display: flex;
            text-align: right;
            margin-bottom: 50px;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-message-textarea {
            max-width: 60%; /* 最大宽度 60% */
            overflow-wrap: break-word; /* 超出时换行 */
            border: 0;
            border-radius: 10px;
            padding: 5px;
            margin-top: 10px;
            background-color: #f1f1f1;
        }

        .ai-message {
            display: flex;
            text-align: left;
            margin-bottom: 50px;
            flex-direction: column;
        }

        .ai-message-textarea {
            max-width: 100%; /* 最大宽度 100% */
            border: 0;
            border-radius: 5px;
            padding: 5px;
            overflow-wrap: break-word; /* 超出时换行 */
            margin-top: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 10px;
        }

        #sendButton:disabled {
            background-color: #ccc;
        }
    </style>
</head>
<body>

<div class="grid-container">
    <div class="grid-x grid-margin-x">
        <div class="cell small-12">
            <div id="title">
                <h4>AI 聊天对话</h4>
            </div>
            <div id="chatContainer">
                <!-- 聊天内容将在这里动态插入 -->
            </div>
            <div class="grid-x grid-margin-x align-middle">
                <div class="cell small-9">
                    <input type="text" id="chatInput" class="form-control" placeholder="请输入您的消息">
                </div>
                <div class="cell small-1">
                    <button id="sendButton" class="button primary" disabled>发送</button>
                </div>
                <div class="cell small-2">
                    <select id="modelSelect" class="form-control">
                        <!-- 从 localStorage 中获取模型名称并填充 -->
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 从 localStorage 中获取模型名称
    let modelSelect = document.getElementById('modelSelect');
    let models = JSON.parse(localStorage.getItem('modelList')) || [];

    models.forEach(modelName => {
        let option = document.createElement('option');
        option.value = modelName;
        option.textContent = modelName;
        modelSelect.appendChild(option);
    });

    // 发送按钮状态控制
    let chatInput = document.getElementById('chatInput');
    let sendButton = document.getElementById('sendButton');
    chatInput.addEventListener('input', () => {
        sendButton.disabled = chatInput.value.trim() === '';
    });

    async function sendMessage() {
        let message = chatInput.value.trim();
        if (message) {
            // 在聊天区域添加用户消息
            document.getElementById('chatContainer').innerHTML += `
                <div class="user-message">
                    <img class="avatar" src="user-avatar.png" alt="用户头像">
                    <span class="user-message-textarea">${message}</span>
                </div>
            `;
            chatInput.value = '';
            sendButton.disabled = true; // 发送后禁用按钮

            let response = await ajax.postStream('/api/chat/completions', {
                "question": message,
                "history": [],
                "stream": true,
                "model": modelSelect.value,
                "temperature": 0.5
            });

            // 处理流
            let reader = response.getReader();
            let decoder = new TextDecoder('utf-8');
            let readStream = async () => {
                let message = `
                    <img class="avatar" src="ai-avatar.png" alt="AI头像">
                    <span class="ai-message-textarea"></span>
                `

                // 必须要创建一个DOM元素，才能在下面使用appendChild()追加
                let wrapper = document.createElement('div');
                wrapper.classList.add('ai-message');
                // 将模板内容追加到DOM元素
                wrapper.innerHTML = message;
                // 将DOM元素追加到页面
                document.getElementById('chatContainer').appendChild(wrapper);

                while (true) {
                    let {done, value} = await reader.read();
                    if (done) break;

                    // 解码并处理每一行
                    let text = decoder.decode(value, {stream: true});
                    text.split('\n').forEach(line => {
                        if (line.trim()) { // 只处理非空行
                            let jsonObject = JSON.parse(line.replaceAll('data: {"text": ', '{"text": '));
                            wrapper.querySelector('.ai-message-textarea').innerHTML += jsonObject.text; // 将文本添加到页面
                        }
                    });
                }
            };
            await readStream(); // 等待流读取完成
        }
    }

    // 发送消息功能
    sendButton.onclick = () => {
        sendMessage();
    };

    // 回车事件
    chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            if (!event.shiftKey) {
                event.preventDefault(); // 阻止换行
                sendMessage();
            }
        }
    });
</script>

</body>
</html>
